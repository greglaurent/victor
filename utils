#!/usr/bin/env bash

HERE=$(cd $(dirname "${BASH_SOURCE[0]}") &>/dev/null && pwd)

declare -A dirs

utils::bootstrap() {
  mkdir -p "${HERE}/repos" >&2

  utils::path::map_dirs
}

utils::exec() {
  local here="${HERE}"
  local -n ref="dirs"
  local dir="${1}"
  local cmd="${2}"

  local path="${ref["${dir}", "${cmd}"]}"

  $("${path}")
}

utils::path::map_dirs() {
  local here="${HERE}"
  local -a out_d
  local -a out_f

  mapfile -t out_d < <(find "${here}" -maxdepth 1 -mindepth 1 -type d -printf '%f\n')

  for d in "${out_d[@]}"; do
    local path="${here}/${d}"
    mapfile -t out_f < <(find "${path}" -maxdepth 1 -mindepth 1 -executable -type f)

    for f in "${out_f[@]}"; do
      local key=$(basename "${f}")
      dirs["${d}", "${key}"]="${f}"
    done
  done
}

utils::path::print_lookup() {
  local -n ref="dirs"
  for d in "${!ref[@]}"; do
    printf 'KEY: %s' "${d}" >&2
    printf "\n" >&2
    printf 'VALUE: %s' "${ref["${d}"]}" >&2
    printf "\n" >&2
  done
}
